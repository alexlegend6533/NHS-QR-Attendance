// Replace the script section in your preferred index.html with this
const BASE_URL = "https://script.google.com/a/macros/houstonchristian.org/s/AKfycbyi930XdjODSUENt9h_-A5nus6GLm9WxFEf-O-KNiy-NnD80YtL4e33NChWvvWL4ljZiQ/exec";

let drift = 0; 

async function syncServer() {
    try {
        const start = Date.now();
        const res = await fetch(BASE_URL + "?action=sync");
        const data = await res.json();
        // Maintain QR sync with server clock
        drift = (data.serverTime + ((Date.now() - start) / 2)) - Date.now();
        document.getElementById('sync-status').innerText = "● SYSTEM SYNCED";
    } catch (e) { 
        document.getElementById('sync-status').innerText = "● SYNC FAILED";
    }
    genQR();
}

function genQR() {
    const container = document.getElementById("qrcode");
    container.innerHTML = "";
    
    // Calculate Key Index
    const now = Date.now() + drift;
    const key = Math.floor(now / 5000); 
    
    new QRCode(container, { 
        text: `${BASE_URL}?key=${key}`, 
        width: 400, 
        height: 400,
        correctLevel : QRCode.CorrectLevel.M 
    });
}

let timeLeft = 5;
setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) { 
        genQR(); 
        timeLeft = 5; 
    }
    document.getElementById('timer').innerText = timeLeft + "s";
}, 1000);

syncServer();
setInterval(syncServer, 120000);
